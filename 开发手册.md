# 创锦排课系统 - 开发手册

## 项目架构

### 技术栈
- **前端**: React 18 + Vite
- **UI框架**: Ant Design 5 + TailwindCSS
- **状态管理**: Zustand
- **桌面框架**: Electron 28
- **数据库**: Better-SQLite3
- **导出**: html2canvas

### 目录结构
```
schedule-system/
├── electron/                    # Electron主进程
│   ├── main.js                 # 应用入口
│   ├── preload.js              # 预加载脚本（IPC桥接）
│   ├── menu.js                 # 应用菜单
│   ├── database/               
│   │   └── connection.js       # 数据库连接和初始化
│   ├── services/               # 业务逻辑层
│   │   ├── studentService.js   # 学生数据服务
│   │   ├── teacherService.js   # 教师数据服务
│   │   └── scheduleService.js  # 课表数据服务
│   └── ipc/
│       └── handlers.js         # IPC处理器注册
├── src/                        # React前端
│   ├── components/
│   │   ├── Layout/             # 布局组件
│   │   ├── Schedule/           # 课表组件
│   │   ├── Settings/           # 设置组件
│   │   └── Common/             # 通用组件
│   ├── store/
│   │   └── scheduleStore.js    # Zustand状态管理
│   ├── utils/
│   │   ├── dateUtils.js        # 日期工具
│   │   ├── exportToPng.js      # PNG导出
│   │   └── constants.js        # 常量定义
│   └── styles/
│       └── schedule.css        # 课表样式
├── public/                     # 静态资源
│   └── logo.png                # 应用Logo
└── resources/                  # 打包资源
    └── icon.png                # 应用图标
```

## 数据模型

### Students（学生表）
```sql
CREATE TABLE students (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  total_hours INTEGER DEFAULT 0,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

### Teachers（教师表）
```sql
CREATE TABLE teachers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  subjects TEXT,  -- JSON格式
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

### Student_Teacher_Subjects（学生-教师-科目关联表）
```sql
CREATE TABLE student_teacher_subjects (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  student_id INTEGER NOT NULL,
  teacher_id INTEGER NOT NULL,
  subject TEXT NOT NULL,
  FOREIGN KEY (student_id) REFERENCES students(id),
  FOREIGN KEY (teacher_id) REFERENCES teachers(id),
  UNIQUE(student_id, subject)
);
```

### Schedules（课程表）
```sql
CREATE TABLE schedules (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  student_id INTEGER NOT NULL,
  teacher_id INTEGER NOT NULL,
  subject TEXT NOT NULL,
  day_of_week INTEGER NOT NULL,      -- 1-7
  time_slot INTEGER NOT NULL,        -- 1-10
  week_start_date TEXT NOT NULL,     -- YYYY-MM-DD
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (student_id) REFERENCES students(id),
  FOREIGN KEY (teacher_id) REFERENCES teachers(id)
);
```

## IPC通信

### 渲染进程 → 主进程

**学生相关**
```javascript
await window.api.getStudents()
await window.api.addStudent({ name, totalHours })
await window.api.updateStudent(id, { name, totalHours })
await window.api.deleteStudent(id)
```

**教师相关**
```javascript
await window.api.getTeachers()
await window.api.addTeacher({ name, subjects })
await window.api.updateTeacher(id, { name, subjects })
await window.api.deleteTeacher(id)
```

**课表相关**
```javascript
await window.api.getSchedules(weekStart)
await window.api.addSchedule(schedule)
await window.api.updateSchedule(id, schedule)
await window.api.deleteSchedule(id)
await window.api.getStudentTeacherSubjects(studentId)
await window.api.setStudentTeacherSubject(studentId, teacherId, subject)
```

## 核心功能实现

### 1. 三表联动机制

当添加学生课程时：
1. 在`schedules`表中插入记录
2. 学生课表自动显示科目名
3. 教师课表自动显示"学生名-科目"
4. 总课表自动显示"学生名-科目(教师名)"

实现原理：
- 所有课程数据存储在同一个`schedules`表
- 不同视图通过SQL查询和数据转换展示不同格式
- 使用事务保证数据一致性

### 2. 课时统计

**本周课时**
```javascript
const weekHours = schedules.filter(
  s => s.student_id === studentId && 
       s.week_start_date === currentWeek
).length;
```

**剩余课时**
```javascript
const usedHours = schedules.filter(
  s => s.student_id === studentId
).length;
const remaining = totalHours - usedHours;
```

### 3. PNG导出

使用html2canvas将DOM转换为图片：

```javascript
const canvas = await html2canvas(element, {
  scale: 2,              // 高清输出
  backgroundColor: '#ffffff',
  useCORS: true,
  allowTaint: true,
});

canvas.toBlob((blob) => {
  // 触发下载
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.download = filename;
  link.href = url;
  link.click();
}, 'image/png');
```

## 开发流程

### 1. 启动开发环境

```bash
# 安装依赖
npm install

# 启动开发服务器（两个终端）
# 终端1：启动Vite
npm run dev

# 终端2：启动Electron
npm run electron

# 或使用合并命令
npm run electron:dev
```

### 2. 调试技巧

**前端调试**
- Electron窗口自动打开DevTools
- 使用React DevTools扩展

**主进程调试**
```javascript
// 在electron/main.js中
console.log('Debug info:', data);
```

**数据库调试**
```javascript
// 查看SQL执行
const db = getDatabase();
db.prepare('SELECT * FROM students').all();
```

### 3. 常见问题

**Q: Better-SQLite3编译失败？**
A: 安装windows-build-tools
```bash
npm install --global windows-build-tools
```

**Q: Electron启动白屏？**
A: 检查Vite是否已启动，确认端口5173可访问

**Q: 数据库文件位置？**
A: `C:\Users\{用户名}\AppData\Roaming\创锦排课系统\schedule-data.db`

## 打包发布

### 配置electron-builder

已在`package.json`中配置：
```json
{
  "build": {
    "appId": "com.chuangjin.schedule",
    "productName": "创锦排课系统",
    "win": {
      "target": ["nsis"],
      "icon": "resources/icon.ico"
    }
  }
}
```

### 执行打包

```bash
npm run electron:build
```

生成文件：
- `dist-electron/创锦排课系统-Setup-1.0.0.exe` - 安装程序
- `dist-electron/win-unpacked/` - 免安装版本

## 扩展开发

### 添加新功能

1. **添加数据表**
   - 在`electron/database/connection.js`中添加建表SQL
   
2. **添加Service**
   - 在`electron/services/`创建新Service
   - 实现CRUD方法

3. **注册IPC Handler**
   - 在`electron/ipc/handlers.js`注册
   - 在`electron/preload.js`暴露API

4. **前端调用**
   - 通过`window.api.xxx()`调用
   - 更新Zustand store

### 样式修改

课表样式在`src/components/Schedule/ScheduleTable.css`：
- 表头颜色：`#D6E4F5`
- 边框颜色：`#333`
- 字体：Microsoft YaHei

## 性能优化

1. **数据库索引**
   - 已为`week_start_date`, `student_id`, `teacher_id`创建索引

2. **React优化**
   - 使用`useMemo`缓存计算结果
   - 避免不必要的重渲染

3. **Electron优化**
   - 使用Better-SQLite3同步API（比异步更快）
   - 合理使用IPC，减少跨进程通信

## 测试

### 功能测试清单
- [ ] 添加/删除学生
- [ ] 添加/删除教师  
- [ ] 设置学生-教师绑定
- [ ] 添加/删除课程
- [ ] 三表同步更新
- [ ] 课时统计正确
- [ ] PNG导出成功
- [ ] 跨周课表管理
- [ ] 数据持久化

### 集成测试
1. 完整排课流程
2. 多学生多教师场景
3. 导出多个课表
4. 数据备份恢复

## 部署

### 给用户的文件
1. `创锦排课系统-Setup-1.0.0.exe` - 安装程序
2. `使用指南.md` - 用户手册
3. `安装说明.md` - 安装指南

### 注意事项
- 确保icon.ico文件存在
- 测试在纯净Windows系统上安装
- 准备常见问题的解决方案

## 维护

### 版本更新
1. 修改`package.json`中的version
2. 更新CHANGELOG.md
3. 重新打包
4. 提供更新说明

### 数据迁移
如需修改数据库结构：
1. 在`connection.js`中添加迁移逻辑
2. 检测数据库版本
3. 执行ALTER TABLE语句
4. 保留向后兼容性
